CELL-FREE RNA ANALYSIS

---

#1 Creating STAR index
STAR --runThreadN 16 --runMode genomeGenerate --genomeDir /mnt/d/Genomes/Human/Gencode_GRCh38_v47/STAR/ --genomeFastaFiles /mnt/d/Genomes/Human/Gencode_GRCh38_v47/GRCh38.primary_assembly.genome.fa --sjdbGTFfile /mnt/d/Genomes/Human/Gencode_GRCh38_v47/gencode.v47.primary_assembly.annotation.gtf --genomeChrBinNbits 15


#2 UMI extraction
for i in *.gz; do umi_tools extract --stdin=$i --bc-pattern=NNNNNNXXXX --log=$i"_processed.log" --stdout "UMI_"$i; done &


#3 Poly-A, Adapter and quality trimming
for i in UMI_*.fastq.gz; do cat $i | bbduk.sh in=stdin.fastq.gz out=trimm_${i} ref=/mnt/d/Ref/polyA.fa,/mnt/d/Ref/truseq_rna.fa k=13 ktrim=r useshortkmers=t mink=5 qtrim=r trimq=10 minlength=20 interleaved=f; done &


#4 Moving trimmed fastq files into new directory
mkdir trimm
mv trimm*.gz ./trimm 


#5 Creating temporary directory for STAR aligment
cd /tmp
mkdir temp_STAR 


#6 Alignment to Genode hg38 primmary assembly, version 47
for i in trimm_UMI*.fastq.gz; do STAR --runThreadN 12 --genomeDir /mnt/d/Genomes/Human/Gencode_GRCh38_v47/STAR --readFilesIn $i --readFilesCommand gunzip -c --outTmpDir /tmp/temp_STAR/temp --outFilterType BySJout --outFilterMultimapNmax 20 --alignSJoverhangMin 8 --alignSJDBoverhangMin 1 --outFilterMismatchNmax 999 --outFilterMismatchNoverLmax 0.1 --alignIntronMin 20 --alignIntronMax 1000000 --alignMatesGapMax 1000000 --outSAMattributes NH HI NM MD --outSAMtype BAM SortedByCoordinate --outFileNamePrefix STAR_gencode_v47/$i; done &


#7 Indexing BAM
for i in trimm*.bam; do samtools index $i; done &


#8 Caunting reads
htseq-count --format bam --stranded yes --type transcript --idattr gene_name --mode union --samout-format bam --nprocesses 16 ./trimm_UMI*.bam /mnt/d/Genomes/Human/Gencode_GRCh38_v47/gencode.v47.primary_assembly.annotation.gtf > v47_transcript.txt


---------------------------


Read class classification from .bam files:

#9 Create faidx from the reference genome
samtools faidx GRCh38_primary_assembly.genome.fa   


#10 Filter only for chromosomes
head -n 25 GRCh38_primary_assembly.genome.fa.fai > genome_filtered.fa.fai


#11 Read class classification
./classify_reads.sh /mnt/d/Genomes/Human/Gencode_GRCh38_v47/gencode.v47.primary_assembly.annotation.gtf /mnt/d/Genomes/Human/Gencode_GRCh38_v47/genome_filtered.fa.fai *.bam          #output in ./classified_reads


#12 Merging all class files into one
echo -ne "Sample\tExon\tCDS\tUTR\tGene\tIntron\tIntergenic\n" > merged_counts.txt
awk '{print FILENAME, $0}' *_counts.txt | sed 's#.*/##' | sed 's/_counts.txt//' >> merged_counts.txt

---------------------------

Read class classification script:

#!/bin/bash

# Check if correct number of arguments are provided
if [ "$#" -lt 3 ]; then
    echo "Usage: $0 <annotation.gtf> <genome.fa.fai> <bam_files...>"
    exit 1
fi

# Input files
GTF_FILE=$1
GENOME_FILE=$2
shift 2  # Remove first two arguments so that $@ now contains only BAM files

# Output directory
OUTPUT_DIR="classified_reads"
mkdir -p $OUTPUT_DIR

echo "Processing annotation file to extract genomic regions..."

# Extract exons
awk '$3 == "exon"' $GTF_FILE > exons.gtf

# Extract CDS (coding sequences)
awk '$3 == "CDS"' $GTF_FILE > cds.gtf

# Extract UTRs (5' and 3' UTRs)
awk '$3 ~ /UTR/' $GTF_FILE > utrs.gtf

# Extract genes
awk '$3 == "gene"' $GTF_FILE > genes.gtf

# Extract intronic regions (genes - exons)
bedtools subtract -a genes.gtf -b exons.gtf > introns.gtf

# Extract intergenic regions (genome - genes)
bedtools complement -i genes.gtf -g $GENOME_FILE > intergenic.bed

echo "Annotation processing complete."

# Process each BAM file
for BAM in "$@"; do
    BASENAME=$(basename "$BAM" .bam)
    echo "Processing $BAM..."

    # Convert BAM to BED12 (preserving spliced alignments)
    bedtools bamtobed -i "$BAM" -bed12 > "$OUTPUT_DIR/${BASENAME}.bed"

    # Classify reads
    bedtools intersect -a "$OUTPUT_DIR/${BASENAME}.bed" -b exons.gtf -wa > "$OUTPUT_DIR/${BASENAME}_exonic.bed"
    bedtools intersect -a "$OUTPUT_DIR/${BASENAME}.bed" -b cds.gtf -wa > "$OUTPUT_DIR/${BASENAME}_cds.bed"
    bedtools intersect -a "$OUTPUT_DIR/${BASENAME}.bed" -b utrs.gtf -wa > "$OUTPUT_DIR/${BASENAME}_utrs.bed"
    bedtools intersect -a "$OUTPUT_DIR/${BASENAME}.bed" -b genes.gtf -wa > "$OUTPUT_DIR/${BASENAME}_genic.bed"
    bedtools intersect -a "$OUTPUT_DIR/${BASENAME}.bed" -b introns.gtf -wa > "$OUTPUT_DIR/${BASENAME}_intronic.bed"
    bedtools intersect -a "$OUTPUT_DIR/${BASENAME}.bed" -b intergenic.bed -wa > "$OUTPUT_DIR/${BASENAME}_intergenic.bed"

    # Count reads for each category
    echo -n "$BASENAME " > "$OUTPUT_DIR/${BASENAME}_counts.txt"
    echo -n "$(wc -l < "$OUTPUT_DIR/${BASENAME}_exonic.bed") " >> "$OUTPUT_DIR/${BASENAME}_counts.txt"
    echo -n "$(wc -l < "$OUTPUT_DIR/${BASENAME}_cds.bed") " >> "$OUTPUT_DIR/${BASENAME}_counts.txt"
    echo -n "$(wc -l < "$OUTPUT_DIR/${BASENAME}_utrs.bed") " >> "$OUTPUT_DIR/${BASENAME}_counts.txt"
    echo -n "$(wc -l < "$OUTPUT_DIR/${BASENAME}_genic.bed") " >> "$OUTPUT_DIR/${BASENAME}_counts.txt"
    echo -n "$(wc -l < "$OUTPUT_DIR/${BASENAME}_intronic.bed") " >> "$OUTPUT_DIR/${BASENAME}_counts.txt"
    echo "$(wc -l < "$OUTPUT_DIR/${BASENAME}_intergenic.bed")" >> "$OUTPUT_DIR/${BASENAME}_counts.txt"

    echo "Classification for $BASENAME completed."
done

echo "All files processed. Check results in the $OUTPUT_DIR directory."
